/**
 * Thunderpush javascript client
 * @version v0.9.0 - 2014-04-11 * @link https://github.com/thunderpush/thunderpush-js
 * @author Krzysztof Jagiełło
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var isMSIE=0,Thunder=new function(){this.channels=[],this.handlers=[],this.reconnect_delays=[1e3,2500,5e3,1e4,3e4,6e4],this.options={log:!1,retry:!0,protocol:"http"};var e=Array.prototype,n=Object.prototype,t=Function.prototype,o=(e.push,e.slice,e.concat,n.toString,n.hasOwnProperty,e.forEach,e.map,e.reduce,e.reduceRight,e.filter,e.every,e.some,e.indexOf),s=(e.lastIndexOf,Array.isArray,Object.keys,t.bind,function(e){return e instanceof s?e:this instanceof s?void(this._wrapped=e):new s(e)});"function"!=typeof/./&&(s.isFunction=function(e){return"function"==typeof e}),s.identity=function(e){return e},s.lookupIterator=function(e){return s.isFunction(e)?e:function(n){return n[e]}},s.sortedIndex=function(e,n,t,o){t=null==t?s.identity:s.lookupIterator(t);for(var i=t.call(o,n),c=0,r=e.length;r>c;){var a=c+r>>>1;t.call(o,e[a])<i?c=a+1:r=a}return c},s.indexOf=function(e,n,t){if(null==e)return-1;var i=0,c=e.length;if(t){if("number"!=typeof t)return i=s.sortedIndex(e,n),e[i]===n?i:-1;i=0>t?Math.max(0,c+t):t}if(o&&e.indexOf===o)return e.indexOf(n,t);for(;c>i;i++)if(e[i]===n)return i;return-1},this.onSockOpen=function(e){"function"==typeof e&&(this.onopen=e)},this.onSockError=function(e){"function"==typeof e&&(this.onerror=e)},this.onSockClose=function(e){"function"==typeof e&&(this.onclose=e)},this.onSockMessage=function(e){"function"==typeof e&&(this.onmessage=e)},this.connect=function(e,n,t,o){this.apikey=n,this.channels=t,this.reconnect_tries=0;for(var s in o)this.options[s]=o[s];this.server=this.options.protocol+"://"+e+"/connect",this.user=this.options.user,this.makeConnection()},this.disconnect=function(){var e=this;return this.socket.onclose=function(n){this.onclose&&this.onclose.call(e,n)},this.socket.readyState===SockJS.OPEN?this.socket.close():!1},this.subscribe=function(e,n,t){if("string"!=typeof e||e.length<=0)throw{name:"channel.invalid",message:"Channel is not a string"};if(this.socket.readyState===SockJS.OPEN)return-1!==s.indexOf(this.channels,e)?("function"==typeof n&&n(this,"Channel already subscribed"),!0):(this.socket.send("SUBSCRIBE "+e),this.channels.push(e),"function"==typeof n&&n(this,"Channel subscribed"),!0);throw"function"==typeof t&&t(this,"Socket not open"),{name:"socket.status",message:"Socket not OPEN: "["this"].socket.readyState}},this.unsubscribe=function(e,n,t){if(this.socket.readyState===SockJS.OPEN){this.socket.send("UNSUBSCRIBE "+e);var o=s.indexOf(this.channels,e);return-1!==o&&(channels=this.channels.splice(o,1)),"function"==typeof n&&n(this,"Channel unsubscribed"),!0}var t="";throw"function"==typeof t&&t(this,"Socket not open"),{name:"socket.status",message:"Socket not OPEN: "["this"].socket.readyState}},this.listen=function(e){this.log("New handler has been registered."),this.handlers.push(e)},this.makeConnection=function(){var e=this;this.socket=new SockJS(this.server,void 0,{debug:this.options.log}),this.socket.onopen=function(n){e.log("Connection has been established."),e.onopen&&e.onopen.call(e,n),e.reconnect_tries=0,e.socket.send("CONNECT "+e.user+":"+e.apikey),e.channels.length&&e.socket.send("SUBSCRIBE "+e.channels.join(":"))},this.socket.onmessage=function(n){e.log("Message has been received",n.data),e.onmessage&&e.onmessage.call(e,n);try{var t=JSON.parse(n.data.payload);n.data=t}catch(n){}for(var o=0;o<e.handlers.length;o++)e.handlers[o](n.data)},this.socket.onerror=function(n){e.onerror&&e.onerror.call(e,n)},this.socket.onclose=function(n){if(e.log("Connection has been lost."),e.onclose&&e.onclose.call(e,n),e.options.retry===!1)return void e.log("Reconnect supressed because of retry option false");if(9e3==n.code||9001==n.code||9002==n.code)return void e.log("Reconnect supressed because of:",n);var t=e.reconnect_delays[e.reconnect_tries]||e.reconnect_delays[e.reconnect_delays.length-1];e.log("Reconnecting in",t,"ms..."),e.reconnect_tries++,setTimeout(function(){e.makeConnection()},t)}},this.log=function(e){if(this.options.log&&"console"in window&&"log"in window.console)if(1==arguments.length)console.log(arguments[0]);else if(isMSIE){var n=Function.prototype.bind.call(console.log,console);n.apply(console,Array.prototype.slice.call(arguments))}else console.log.apply(console,Array.prototype.slice.call(arguments))}};
